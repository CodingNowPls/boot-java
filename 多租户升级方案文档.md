# 多租户架构升级方案文档

## 一、项目现状分析

### 1.1 当前架构
- **项目类型**: RuoYi-Vue 框架，基于 Spring Boot + Vue
- **多租户基础**: 已存在 `boot-common-tenant` 模块，但未完全启用
- **数据库**: mysql，已有部分表包含 `tenant_id` 字段
- **集成组件**: 
  - Jimu报表（已有 `tenant_id` 字段，varchar类型）
  - Magic-API（需要多租户支持）
  - 工作流引擎（已有 `tenant_id` 字段，varchar类型）

### 1.2 当前多租户状态
- **配置状态**: `tenant.enable: false`（未启用）
- **租户字段**: 统一使用 `tenant_id`（与Jimu、工作流保持一致）
- **拦截器**: 已实现 `TenantMybatisPlusConfig`，但未完全集成
- **登录逻辑**: 当前为单租户登录，无租户选择功能

### 1.3 设计理念
**核心思想：多租户架构兼容单租户模式**
- **统一架构**: 所有数据表都包含 `tenant_id` 字段，单租户和多租户使用同一套代码逻辑
- **单租户模式**: 
  - 默认创建 `tenant_id = 1` 的默认租户
  - 用户无感知，系统自动使用默认租户
  - 可通过配置决定是否在登录界面显示租户下拉框（显示或不显示）
- **多租户模式**: 
  - 存在多个租户（tenant_id = 1, 2, 3...）
  - 登录界面必须显示租户选择下拉框
  - 用户可以选择不同的租户登录
- **平滑切换**: 从单租户升级到多租户无需修改代码，只需创建新租户并调整配置

### 1.3 关键问题识别

#### 1.3.1 数据库设计问题
- **字段命名统一**: 
  - 统一使用 `tenant_id`（与Jimu、工作流保持一致）
  - 所有业务表都需要添加 `tenant_id` 字段
  - 字段类型：bigint(20) 或 varchar(50)（根据现有表结构决定）
- **缺失表结构**:
  - 缺少租户表（`sys_tenant`）
  - 缺少用户租户关系表（`sys_user_tenant`）
  - 缺少租户菜单相关表（`sys_menu_pack`、`sys_menu_pack_detail`、`sys_tenant_menu_pack`）

#### 1.3.2 登录界面配置需求
- **需求**: 登录界面可通过配置表动态控制租户下拉框显示
- **场景**:
  - **单租户模式**：
    - 系统只有一个租户（tenant_id = 1）
    - 可通过配置 `sys.login.showTenantSelect` 决定是否显示租户下拉框
    - 如果显示：下拉框只有一个选项（默认租户），用户无感知
    - 如果不显示：用户直接登录，系统自动使用默认租户
  - **多租户模式**：
    - 系统有多个租户（tenant_id = 1, 2, 3...）
    - 必须显示租户下拉框，支持选择多个租户
    - 用户可以选择不同的租户登录
- **实现方式**: 通过 `sys_config` 配置表控制

#### 1.3.3 集成组件多租户支持
- **Jimu报表**: 表结构已有 `tenant_id`（varchar类型），需要确保查询时自动过滤
- **Magic-API**: 需要支持多租户上下文，API脚本执行时需携带租户ID
- **工作流引擎**: 已有 `tenant_id`（varchar类型），需要验证自动过滤逻辑

## 二、升级目标

### 2.1 核心目标
1. **统一的多租户架构**: 单租户和多租户使用同一套代码逻辑，通过配置切换
2. **灵活的登录配置**: 通过配置表控制登录界面租户下拉框显示
3. **组件集成**: 确保 Jimu、Magic-API 等组件支持多租户
4. **数据隔离**: 所有业务表自动按租户隔离，单租户时自动使用默认租户

### 2.2 功能目标
- ✅ 管理后台：租户管理、租户菜单管理、用户分配
- ✅ 业务后台：租户内用户管理、角色管理、部门管理
- ✅ 登录界面：根据配置动态显示租户选择（单租户可配置显示/隐藏，多租户必须显示）
- ✅ 租户切换：业务后台支持切换不同租户
- ✅ 单租户兼容：单租户模式下用户无感知，系统自动使用默认租户

## 三、数据库设计

### 3.1 核心表结构

#### 3.1.1 租户表
```sql
CREATE TABLE `sys_tenant` (
  `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
  `tenant_name` varchar(100) NOT NULL COMMENT '租户名称',
  `tenant_code` varchar(50) DEFAULT NULL COMMENT '租户编码',
  `contact_name` varchar(50) DEFAULT NULL COMMENT '联系人',
  `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系电话',
  `contact_email` varchar(100) DEFAULT NULL COMMENT '联系邮箱',
  `status` char(1) DEFAULT '0' COMMENT '状态（0正常 1停用）',
  `del_flag` char(1) DEFAULT '0' COMMENT '删除标志（0存在 2删除）',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  PRIMARY KEY (`tenant_id`),
  UNIQUE KEY `uk_tenant_code` (`tenant_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户表';
```

#### 3.1.2 用户租户关系表
```sql
CREATE TABLE `sys_user_tenant` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
  `disabled` char(1) DEFAULT '0' COMMENT '是否禁用（0正常 1禁用）',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_tenant` (`user_id`, `tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户租户关系表';
```

#### 3.1.3 租户菜单表
```sql
CREATE TABLE `sys_menu_pack` (
  `pack_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '租户菜单ID',
  `pack_name` varchar(100) NOT NULL COMMENT '租户菜单名称',
  `pack_code` varchar(50) DEFAULT NULL COMMENT '租户菜单编码',
  `status` char(1) DEFAULT '0' COMMENT '状态（0正常 1停用）',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`pack_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单表';
```

#### 3.1.4 租户菜单详情表
```sql
CREATE TABLE `sys_menu_pack_detail` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `pack_id` bigint(20) NOT NULL COMMENT '租户菜单ID',
  `menu_id` bigint(20) NOT NULL COMMENT '菜单ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_pack_menu` (`pack_id`, `menu_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单详情表';
```

#### 3.1.5 租户菜单关联表
```sql
CREATE TABLE `sys_tenant_menu_pack` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
  `pack_id` bigint(20) NOT NULL COMMENT '租户菜单ID',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_pack` (`tenant_id`, `pack_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单关联表';
```

### 3.2 现有表结构改造

#### 3.2.1 用户表（sys_user）改造
```sql
-- 增加字段
ALTER TABLE `sys_user` 
  ADD COLUMN `is_sys` char(1) DEFAULT '0' COMMENT '是否系统用户（0否 1是）' AFTER `user_type`,
  ADD COLUMN `admin_login_tenant_id` varchar(50) DEFAULT NULL COMMENT '管理后台最后登录租户ID' AFTER `login_date`,
  ADD COLUMN `business_login_tenant_id` varchar(50) DEFAULT NULL COMMENT '业务后台最后登录租户ID' AFTER `admin_login_tenant_id`;

-- 为现有数据设置默认值
UPDATE `sys_user` SET `is_sys` = '1' WHERE `user_name` = 'admin';
```

#### 3.2.2 部门表（sys_dept）改造
```sql
-- 增加租户字段（如果不存在）
ALTER TABLE `sys_dept` 
  ADD COLUMN `tenant_id` varchar(50) DEFAULT NULL COMMENT '租户ID' AFTER `dept_id`;

-- 创建索引
CREATE INDEX `idx_tenant_id` ON `sys_dept` (`tenant_id`);

-- 为现有数据设置默认租户ID（单租户模式）
UPDATE `sys_dept` SET `tenant_id` = '1' WHERE `tenant_id` IS NULL;
```

#### 3.2.3 角色表（sys_role）改造
```sql
-- 增加字段（如果不存在）
ALTER TABLE `sys_role` 
  ADD COLUMN `tenant_id` varchar(50) DEFAULT NULL COMMENT '租户ID（0表示管理后台角色）' AFTER `role_id`,
  ADD COLUMN `is_admin` char(1) DEFAULT '0' COMMENT '是否管理员（0否 1是）' AFTER `role_key`;

-- 创建索引
CREATE INDEX `idx_tenant_id` ON `sys_role` (`tenant_id`);

-- 为现有数据设置默认值（管理后台角色设置为'0'，业务角色设置为'1'）
UPDATE `sys_role` SET `tenant_id` = '0' WHERE `tenant_id` IS NULL AND `role_key` LIKE 'admin%';
UPDATE `sys_role` SET `tenant_id` = '1' WHERE `tenant_id` IS NULL AND `role_key` NOT LIKE 'admin%';
```

#### 3.2.4 菜单表（sys_menu）改造
```sql
-- 增加字段
ALTER TABLE `sys_menu` 
  ADD COLUMN `is_sys` char(1) DEFAULT '0' COMMENT '是否系统菜单（0业务菜单 1系统菜单）' AFTER `menu_type`;
```

### 3.3 登录配置表扩展

在 `sys_config` 表中增加以下配置项：

```sql
-- 登录界面配置：是否显示租户选择（单租户模式下可配置，多租户模式下必须显示）
INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
VALUES ('登录界面-是否显示租户选择', 'sys.login.showTenantSelect', 'false', 'Y', 'admin', NOW(), '是否在登录界面显示租户选择下拉框（true显示 false隐藏，单租户模式有效，多租户模式强制显示）');

-- 系统模式配置：单租户/多租户（系统自动判断，也可手动配置）
INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
VALUES ('系统模式-租户模式', 'sys.tenant.mode', 'auto', 'Y', 'admin', NOW(), '系统租户模式：auto自动判断 single单租户 multi多租户（auto：根据租户数量自动判断）');

-- 默认租户ID配置
INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
VALUES ('系统配置-默认租户ID', 'sys.tenant.defaultTenantId', '1', 'Y', 'admin', NOW(), '单租户模式下的默认租户ID，通常为"1"（字符串类型）');
```

**配置说明**：
- **单租户模式**：
  - `sys.tenant.mode = 'single'` 或系统自动判断（租户数量=1）
  - `sys.login.showTenantSelect = 'false'`：不显示租户下拉框，用户直接登录，系统自动使用默认租户（tenant_id='1'）
  - `sys.login.showTenantSelect = 'true'`：显示租户下拉框，但只有一个选项（默认租户），用户无感知
- **多租户模式**：
  - `sys.tenant.mode = 'multi'` 或系统自动判断（租户数量>1）
  - `sys.login.showTenantSelect` 强制为 `true`，必须显示租户下拉框
  - 用户可以选择不同的租户登录

**注意**：所有 `tenant_id` 字段统一使用 `varchar(50)` 类型，与Jimu报表和工作流引擎保持一致。

## 四、代码改造方案

### 4.1 后端改造

#### 4.1.1 多租户配置调整

**文件**: `boot-admin/src/main/resources/application.yml`

```yaml
tenant:
  # 租户模式是否启用
  enable: true
  # 租户字段名（统一使用 tenant_id，与Jimu、工作流保持一致）
  column: tenant_id
  # 默认租户ID（单租户模式使用'1'，管理后台使用'0'，字符串类型）
  defaultTenantId: '1'
  # 排除表（不进行租户过滤的表）
  excludes:
    - sys_tenant                  # 租户表
    - sys_menu_pack               # 租户菜单表
    - sys_menu_pack_detail        # 租户菜单详情表
    - sys_tenant_menu_pack        # 租户菜单关联表
    - sys_user_tenant             # 用户租户关系表
    - sys_config                  # 系统配置表
    - sys_dict_data               # 字典数据表
    - sys_dict_type               # 字典类型表
    - sys_menu                    # 菜单表
    - sys_user                    # 用户表
    - sys_user_org                # 用户组织关系表
    - sys_role_menu               # 角色菜单关联表
    - sys_user_role               # 用户角色关联表
    - sys_user_post               # 用户岗位关联表
    - sys_role_dept               # 角色部门关联表
    - gen_table                   # 代码生成表
    - gen_table_column            # 代码生成字段表
    - sys_job                     # 定时任务表
    - sys_job_log                 # 定时任务日志表
    - sys_logininfor              # 登录日志表
    - sys_oper_log                # 操作日志表
    - sys_notice                  # 通知公告表
    # Quartz相关表
    - qrtz_blob_triggers
    - qrtz_calendars
    - qrtz_cron_triggers
    - qrtz_fired_triggers
    - qrtz_job_details
    - qrtz_locks
    - qrtz_paused_trigger_grps
    - qrtz_scheduler_state
    - qrtz_simple_triggers
    - qrtz_simprop_triggers
    - qrtz_triggers
    # Jimu报表相关表（部分表需要租户隔离，部分不需要）
    - jimu_dict                   # 字典表（全局）
    - jimu_dict_item              # 字典项表（全局）
    - jimu_report_map             # 地图配置表（全局）
    # Magic-API相关表（需要根据实际情况调整）
```

#### 4.1.2 租户拦截器调整

**文件**: `boot-common/boot-common-tenant/src/main/java/com/boot/common/tenant/config/TenantMybatisPlusConfig.java`

当前代码已使用 `SecurityUtils.getCurrentTenantId()`，与字段名 `tenant_id` 一致，但需要调整返回值类型。

**关键修改**：
- `getCurrentTenantId()` 返回类型为 `String`，与数据库字段类型一致
- 在 `getTenantId()` 方法中，需要使用 `StringValue` 而不是 `LongValue` 来构建Expression

**修改后的代码**：
```java
@Override
public Expression getTenantId() {
    //从登录信息中获取当前租户ID（String类型）
    String tenantId = SecurityUtils.getCurrentTenantId();
    if (tenantId == null) {
        return new NullValue();
    }
    // 使用StringValue而不是LongValue，因为tenant_id是varchar类型
    return new StringValue(tenantId);
}
```

**关键逻辑**：
- 单租户模式：如果 `getCurrentTenantId()` 返回 null，使用默认租户ID（'1'）
- 多租户模式：从登录用户信息中获取当前租户ID（字符串类型）
- 管理后台：使用租户ID = '0'（不进行租户过滤）

**注意**：
- `getCurrentTenantId()` 返回类型为 `String`
- MyBatis-Plus的Expression需要使用 `StringValue` 来包装字符串类型的租户ID
- 需要导入：`import net.sf.jsqlparser.expression.StringValue;`

#### 4.1.3 登录服务改造

**文件**: `boot-system/src/main/java/com/boot/system/service/impl/UserSaServiceImpl.java`

需要实现以下逻辑：
1. 支持管理后台登录和业务后台登录区分
2. 业务后台登录时，从 `sys_user_org` 表查询用户所属组织
3. 优先使用上次登录的组织，否则使用第一个组织
4. 将组织ID存入 `LoginUser` 对象

**关键代码逻辑**：
```java
// 判断是否为管理后台登录
Boolean isAdminLogin = AuthenticationContextHolder.getIsAdminLogin();
String currentTenantId = Constants.ADMIN_DEFAULT_TENANT_ID; // 管理后台默认为"0"

if (!isAdminLogin) {
    // 业务后台登录：查询用户所属租户
    List<SysUserTenant> userTenantList = sysUserTenantService.selectByUserId(userId);
    if (userTenantList == null || userTenantList.isEmpty()) {
        // 单租户模式：如果没有租户关系，使用默认租户
        currentTenantId = Constants.DEFAULT_TENANT_ID; // 默认租户ID = "1"
    } else if (userTenantList.size() == 1) {
        // 单租户模式：只有一个租户，直接使用
        currentTenantId = userTenantList.get(0).getTenantId();
    } else {
        // 多租户模式：多个租户，优先使用上次登录的租户
        String lastTenantId = user.getBusinessLoginTenantId();
        if (lastTenantId != null && userTenantList.stream().anyMatch(ut -> ut.getTenantId().equals(lastTenantId))) {
            currentTenantId = lastTenantId;
        } else {
            // 使用第一个租户
            currentTenantId = userTenantList.get(0).getTenantId();
        }
    }
}
```

**注意**：所有租户ID相关变量使用 `String` 类型，与数据库字段类型一致。

#### 4.1.4 登录接口改造

**文件**: `boot-system/src/main/java/com/boot/system/controller/SysLoginController.java`

需要增加登录参数：
- `isAdminLogin`: 是否为管理后台登录
- `tenantId`: 选择的租户ID（String类型，业务后台登录时，多租户模式必填，单租户模式可选）

**新增接口**：
```java
@PostMapping("/login")
public AjaxResult login(@RequestBody LoginBody loginBody) {
    // 支持 isAdminLogin 和 tenantId 参数
    // 单租户模式：如果tenantId为空，使用默认租户（"1"）
    // 多租户模式：tenantId必填
    // tenantId 为 String 类型
    // ...
}

@GetMapping("/getTenantList")
public AjaxResult getTenantList(@RequestParam(required = false) String username) {
    // 获取用户可访问的租户列表
    // 如果传入了username，返回该用户可访问的租户列表（登录前查询）
    // 如果未传入，返回当前登录用户可访问的租户列表
    // 返回的租户ID为 String 类型
    // ...
}
```

#### 4.1.5 登录配置服务

**文件**: `boot-system/src/main/java/com/boot/system/service/ISysConfigService.java`

新增方法：
```java
/**
 * 获取登录界面配置
 */
LoginConfigVO getLoginConfig();
```

**配置VO**:
```java
public class LoginConfigVO {
    private Boolean showTenantSelect;   // 是否显示租户选择
    private String tenantMode;          // 租户模式：auto/single/multi
    private String defaultTenantId;     // 默认租户ID（单租户模式，String类型）
    private List<TenantVO> tenantList;  // 用户可访问的租户列表（多租户模式）
    private Integer tenantCount;        // 系统租户数量（用于自动判断模式）
}
```

### 4.2 前端改造

#### 4.2.1 登录页面改造

**文件**: `boot-ui/src/views/login.vue`

**改造要点**：
1. 页面加载时调用接口获取登录配置
2. 根据配置决定是否显示租户选择下拉框
3. **单租户模式**：
   - 如果 `showTenantSelect = false`：不显示租户下拉框，用户直接登录，系统自动使用默认租户（tenant_id=1）
   - 如果 `showTenantSelect = true`：显示租户下拉框，但只有一个选项（默认租户），用户无感知
4. **多租户模式**：必须显示租户下拉框，支持选择多个租户
5. 增加管理后台/业务后台切换按钮

**关键代码逻辑**：
```javascript
data() {
  return {
    loginForm: {
      userName: '',
      password: '',
      code: '',
      uuid: '',
      tenantId: null,        // 新增：选择的租户ID
      isAdminLogin: false    // 新增：是否管理后台登录
    },
    loginConfig: {
      showTenantSelect: false,
      tenantMode: 'auto',    // auto/single/multi
      defaultTenantId: 1,
      tenantList: [],
      tenantCount: 1
    }
  }
},
created() {
  this.getLoginConfig();  // 获取登录配置
  this.getCode();
  this.getCookie();
},
methods: {
  async getLoginConfig() {
    // 调用接口获取登录配置
    const res = await getLoginConfig();
    this.loginConfig = res.data;
    
    // 自动判断租户模式
    if (this.loginConfig.tenantMode === 'auto') {
      this.loginConfig.tenantMode = this.loginConfig.tenantCount > 1 ? 'multi' : 'single';
    }
    
    // 根据配置决定是否显示租户选择
    if (this.loginConfig.tenantMode === 'multi') {
      // 多租户模式：必须显示租户选择
      this.loginConfig.showTenantSelect = true;
      // 获取用户可访问的租户列表（登录前可能需要用户名预查询）
      if (this.loginForm.userName) {
        await this.getTenantList(this.loginForm.userName);
      }
    } else {
      // 单租户模式：根据配置决定
      // showTenantSelect 已经在后端根据配置返回
      if (this.loginConfig.showTenantSelect) {
        // 单租户但显示下拉框：设置默认租户
        this.loginForm.tenantId = this.loginConfig.defaultTenantId; // String类型
        this.loginConfig.tenantList = [{
          tenantId: this.loginConfig.defaultTenantId, // String类型
          tenantName: '默认租户'
        }];
      } else {
        // 单租户且不显示下拉框：使用默认租户，但不显示
        this.loginForm.tenantId = this.loginConfig.defaultTenantId; // String类型
      }
    }
  },
  async getTenantList(username) {
    // 获取用户可访问的租户列表
    // 登录前：传入用户名进行预查询
    // 登录后：不传用户名，返回当前用户的租户列表
    const res = await getTenantList(username);
    this.loginConfig.tenantList = res.data;
  }
}
```

#### 4.2.2 登录API改造

**文件**: `boot-ui/src/api/login.js`

新增接口：
```javascript
// 获取登录配置
export function getLoginConfig() {
  return request({
    url: '/system/config/loginConfig',
    method: 'get'
  })
}

// 获取组织列表（登录前）
export function getOrgListByUsername(username) {
  return request({
    url: '/system/org/listByUsername',
    method: 'get',
    params: { username }
  })
}
```

#### 4.2.3 用户Store改造

**文件**: `boot-ui/src/store/modules/user.js`

需要存储租户信息：
```javascript
state: {
  tenantId: null,        // 当前租户ID
  tenantName: null,      // 当前租户名称
  isAdminLogin: false,   // 是否管理后台登录
  tenantList: [],        // 用户可访问的租户列表
  tenantMode: 'auto'     // 租户模式：auto/single/multi
}
```

### 4.3 集成组件改造

#### 4.3.1 Jimu报表多租户支持

**问题**: Jimu报表表已有 `tenant_id` 字段（varchar类型），需要确保与系统业务表类型一致

**解决方案**：
1. **统一使用 `tenant_id` 且统一为字符串类型**（推荐，与Jimu、工作流完全一致）
   - Jimu报表表已使用 `tenant_id`（varchar类型），无需修改
   - 工作流表已使用 `tenant_id`（varchar类型），无需修改
   - 系统业务表统一使用 `tenant_id`（varchar(50)类型）
   - 所有表字段类型完全一致，无需类型转换

2. **类型统一优势**：
   - 代码中统一使用 `String` 类型处理租户ID
   - 无需类型转换，避免类型不匹配问题
   - 与Jimu、工作流组件完全兼容

**推荐统一使用 `varchar(50)` 类型**，与现有Jimu、工作流保持一致，避免类型转换问题。

#### 4.3.2 Magic-API多租户支持

**问题**: Magic-API脚本执行时需要获取当前租户上下文

**解决方案**：
1. **自定义Magic-API配置类**，注入租户上下文
2. **在Magic-API脚本中**，通过全局变量获取租户ID
3. **Magic-API数据源配置**，需要支持租户隔离

**实现步骤**：
1. 创建 `MagicApiTenantInterceptor`，在API执行前设置租户上下文
2. 在Magic-API配置中注册租户相关的全局变量
3. 确保Magic-API的数据源查询自动携带租户条件

**文件**: `boot-common/boot-common-magic-api/src/main/java/com/boot/common/magicapi/config/MagicApiTenantConfig.java`

```java
@Configuration
public class MagicApiTenantConfig {
    
    @Bean
    public MagicConfiguration magicConfiguration() {
        MagicConfiguration configuration = new MagicConfiguration();
        // 注册租户相关的全局变量
        configuration.setMagicScriptVariable("tenant", new TenantVariable());
        return configuration;
    }
    
    public static class TenantVariable implements MagicScriptVariable {
        @Override
        public Object getValue() {
            return SecurityUtils.getCurrentOrgId();
        }
    }
}
```

#### 4.3.3 工作流引擎多租户支持

**现状**: 工作流相关表已有 `tenant_id` 字段

**需要验证**：
1. 工作流表的 `tenant_id` 字段是否与系统 `org_id` 一致
2. 工作流查询是否自动过滤租户
3. 工作流实例创建时是否自动设置租户ID

**处理方案**：
- 如果字段名不一致，统一改为 `org_id`
- 确保工作流相关表在租户拦截器的排除列表中（如果需要全局可见）或包含列表中（如果需要租户隔离）

## 五、升级步骤

### 5.1 准备阶段

1. **备份数据库**
   ```bash
   # 备份当前数据库
   sqlite3 boot-java.db .dump > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **代码备份**
   ```bash
   # 创建升级分支
   git checkout -b feature/multi-tenant-upgrade
   git commit -m "备份：多租户升级前代码"
   ```

3. **环境准备**
   - 准备测试环境
   - 准备数据迁移脚本

### 5.2 数据库升级

#### 步骤1: 创建新表
```sql
-- 执行 3.1 节中的表创建脚本
-- sys_tenant（租户表）
-- sys_user_tenant（用户租户关系表）
-- sys_menu_pack（租户菜单表）
-- sys_menu_pack_detail（租户菜单详情表）
-- sys_tenant_menu_pack（租户菜单关联表）
```

#### 步骤2: 修改现有表结构
```sql
-- 执行 3.2 节中的表结构修改脚本
-- sys_user 增加字段（is_sys, admin_login_tenant_id, business_login_tenant_id）
-- sys_dept 增加 tenant_id（如果不存在）
-- sys_role 增加 tenant_id 和 is_admin（如果不存在）
-- sys_menu 增加 is_sys（如果不存在）

-- 注意：Jimu和工作流表已有 tenant_id 字段，无需修改
```

#### 步骤3: 数据迁移
```sql
-- 1. 创建默认租户（单租户模式，tenant_id使用字符串）
INSERT INTO sys_tenant (tenant_id, tenant_name, tenant_code, status, create_by, create_time)
VALUES ('1', '默认租户', 'DEFAULT', '0', 'admin', NOW());

-- 2. 为现有用户创建租户关系（单租户模式，所有用户属于默认租户）
INSERT INTO sys_user_tenant (user_id, tenant_id, disabled, create_by, create_time)
SELECT user_id, '1', '0', 'admin', NOW() FROM sys_user WHERE del_flag = '0';

-- 3. 为现有部门设置租户ID（单租户模式，使用字符串）
UPDATE sys_dept SET tenant_id = '1' WHERE tenant_id IS NULL;

-- 4. 为现有角色设置租户ID（使用字符串）
-- 管理后台角色设置为'0'
UPDATE sys_role SET tenant_id = '0' WHERE tenant_id IS NULL AND role_key LIKE 'admin%';
-- 业务角色设置为'1'（默认租户）
UPDATE sys_role SET tenant_id = '1' WHERE tenant_id IS NULL AND role_key NOT LIKE 'admin%';

-- 5. 设置菜单的 is_sys 标识（需要根据实际菜单分类）
-- 管理后台菜单设置为 is_sys = '1'
-- 业务菜单设置为 is_sys = '0'
```

#### 步骤4: 字段类型统一（已完成）
```sql
-- 所有表的 tenant_id 字段已统一为 varchar(50) 类型
-- Jimu报表表：tenant_id varchar(10) - 保持现有类型或统一为varchar(50)
-- 工作流表：tenant_id varchar(50) - 保持现有类型
-- 系统业务表：tenant_id varchar(50) - 新建或修改为此类型
-- 注意：如果Jimu表使用varchar(10)，建议统一为varchar(50)以保持一致性
```

### 5.3 代码升级

#### 步骤1: 更新配置文件
- 修改 `application.yml`，启用多租户：`tenant.enable: true`
- 更新排除表列表

#### 步骤2: 后端代码改造
1. 调整 `TenantMybatisPlusConfig`，确保使用 `org_id`
2. 改造 `UserSaServiceImpl`，实现组织查询逻辑
3. 改造 `SysLoginController`，支持组织参数
4. 新增组织管理相关Controller、Service、Mapper
5. 新增租户菜单管理相关功能

#### 步骤3: 前端代码改造
1. 改造 `login.vue`，支持组织选择
2. 新增登录配置获取接口调用
3. 更新用户Store，存储组织信息
4. 新增组织切换功能（业务后台）

#### 步骤4: 集成组件改造
1. Jimu报表：统一字段名为 `org_id`
2. Magic-API：添加租户上下文支持
3. 工作流：验证并调整租户字段

### 5.4 测试验证

#### 功能测试
1. **登录测试**
   - 单租户模式：不显示组织选择
   - 单租户模式（配置显示）：显示组织选择
   - 多租户模式：显示组织选择，支持选择
   - 管理后台登录：不显示组织选择

2. **数据隔离测试**
   - 创建两个组织
   - 每个组织创建用户、部门、角色
   - 验证数据隔离：组织A的用户看不到组织B的数据

3. **菜单权限测试**
   - 创建租户菜单
   - 为租户分配菜单
   - 验证租户用户只能看到分配的菜单

4. **集成组件测试**
   - Jimu报表：验证报表数据按组织隔离
   - Magic-API：验证API脚本能获取租户上下文
   - 工作流：验证流程实例按组织隔离

#### 性能测试
- 多租户查询性能
- 租户切换性能
- 大数据量下的隔离性能

### 5.5 上线部署

1. **生产环境准备**
   - 数据库备份
   - 代码部署
   - 配置更新

2. **数据迁移**
   - 执行生产环境数据迁移脚本
   - 验证数据完整性

3. **功能验证**
   - 生产环境功能验证
   - 监控系统运行状态

## 六、关键问题与解决方案

### 6.1 登录配置的获取时机

**问题**: 登录前无法获取用户信息，如何获取用户可访问的组织列表？

**解决方案**:
1. **方案一（推荐）**: 登录时先验证用户名密码，返回可访问的组织列表，用户选择组织后完成登录
   - 第一步：调用 `/login/preCheck`，传入用户名密码，返回组织列表
   - 第二步：用户选择组织后，调用 `/login`，传入组织ID，完成登录

2. **方案二**: 登录配置中不包含用户特定的组织列表，登录时根据用户名查询
   - 登录接口增加 `username` 参数预查询
   - 返回该用户可访问的组织列表

### 6.2 单租户与多租户的兼容

**问题**: 如何在同一套代码中支持单租户和多租户模式？

**解决方案**:
1. 通过配置表 `sys.tenant.mode` 控制模式
2. 代码中根据配置决定是否显示组织选择
3. 单租户模式：默认组织ID为1，不显示组织选择（除非配置显示）
4. 多租户模式：必须显示组织选择，支持切换

### 6.3 Magic-API的租户上下文

**问题**: Magic-API脚本执行时如何获取当前租户？

**解决方案**:
1. 通过Sa-Token获取当前登录用户
2. 从LoginUser中获取组织ID
3. 在Magic-API配置中注册全局变量 `tenant`，脚本中可直接使用

### 6.4 历史数据迁移

**问题**: 现有单租户数据如何迁移到多租户？

**解决方案**:
1. 创建默认组织（org_id = 1）
2. 所有现有数据设置 `org_id = 1`
3. 为所有用户创建组织关系（user_id -> org_id = 1）
4. 管理后台角色设置 `org_id = 0`

### 6.5 字段命名统一

**问题**: 系统需要统一租户字段名

**解决方案**:
**统一使用 `tenant_id` 且统一为字符串类型**（已确定）
- Jimu报表表已使用 `tenant_id`（varchar类型）
- 工作流表已使用 `tenant_id`（varchar类型）
- 系统业务表统一使用 `tenant_id`（varchar(50)类型）
- 更新配置文件：`tenant.column: tenant_id`

**字段类型统一**：
- 所有表：`tenant_id varchar(50)` - 统一使用varchar类型
- 代码中统一使用 `String` 类型处理租户ID
- 无需类型转换，完全兼容

**优势**：
- 与现有Jimu、工作流组件完全一致，无需修改表结构
- 减少数据库迁移工作量
- 代码中无需类型转换，避免类型不匹配问题
- 符合多租户通用命名规范

## 七、风险评估

### 7.1 技术风险

| 风险项 | 风险等级 | 影响 | 应对措施 |
|--------|---------|------|---------|
| 数据迁移失败 | 高 | 数据丢失 | 完整备份，分步迁移，回滚方案 |
| 性能下降 | 中 | 查询变慢 | 索引优化，查询优化，缓存策略 |
| 兼容性问题 | 中 | 功能异常 | 充分测试，灰度发布 |
| 集成组件异常 | 中 | 功能不可用 | 提前验证，降级方案 |

### 7.2 业务风险

| 风险项 | 风险等级 | 影响 | 应对措施 |
|--------|---------|------|---------|
| 用户无法登录 | 高 | 业务中断 | 保留单租户模式，快速回滚 |
| 数据隔离失效 | 高 | 数据泄露 | 严格测试，权限验证 |
| 菜单权限混乱 | 中 | 功能异常 | 权限测试，租户菜单验证 |

## 八、回滚方案

### 8.1 代码回滚
```bash
# 回滚到升级前版本
git checkout <previous-commit>
# 重新部署
```

### 8.2 数据库回滚
```bash
# 恢复数据库备份
sqlite3 boot-java.db < backup_YYYYMMDD_HHMMSS.sql
```

### 8.3 配置回滚
```yaml
# 关闭多租户
tenant:
  enable: false
```

## 九、后续优化建议

1. **性能优化**
   - 租户数据缓存策略
   - 查询语句优化
   - 索引优化

2. **功能增强**
   - 组织层级管理
   - 组织数据导入导出
   - 组织数据统计

3. **监控告警**
   - 租户数据量监控
   - 跨租户访问告警
   - 性能监控

## 十、单租户兼容多租户设计说明

### 10.1 设计理念

**核心思想：多租户架构兼容单租户模式，使用同一套代码逻辑**

- **统一架构**：所有数据表都包含 `tenant_id` 字段，无论是单租户还是多租户
- **代码统一**：单租户和多租户使用完全相同的代码逻辑，通过配置和租户数量自动判断模式
- **用户感知**：
  - **单租户模式**：用户无感知，系统自动使用默认租户（tenant_id=1）
  - **多租户模式**：用户需要选择租户，系统根据选择进行数据隔离

### 10.2 单租户模式实现

#### 10.2.1 数据层面
```sql
-- 1. 创建默认租户（tenant_id使用字符串）
INSERT INTO sys_tenant (tenant_id, tenant_name, tenant_code) 
VALUES ('1', '默认租户', 'DEFAULT');

-- 2. 所有数据默认属于租户'1'（tenant_id使用字符串）
UPDATE sys_dept SET tenant_id = '1' WHERE tenant_id IS NULL;
UPDATE sys_role SET tenant_id = '1' WHERE tenant_id IS NULL AND tenant_id != '0';

-- 3. 所有用户默认属于租户'1'（tenant_id使用字符串）
INSERT INTO sys_user_tenant (user_id, tenant_id)
SELECT user_id, '1' FROM sys_user WHERE del_flag = '0';
```

#### 10.2.2 代码层面
```java
// 登录时自动判断（tenantId为String类型）
String tenantId = null;
if (isAdminLogin) {
    tenantId = "0"; // 管理后台
} else {
    List<SysUserTenant> userTenantList = getUserTenantList(userId);
    if (userTenantList.size() == 1) {
        // 单租户模式：只有一个租户，直接使用
        tenantId = userTenantList.get(0).getTenantId();
    } else if (userTenantList.size() > 1) {
        // 多租户模式：需要用户选择
        tenantId = loginBody.getTenantId(); // 从登录参数获取（String类型）
    } else {
        // 没有租户关系，使用默认租户
        tenantId = Constants.DEFAULT_TENANT_ID; // "1"
    }
}
```

#### 10.2.3 前端层面
```javascript
// 单租户模式：根据配置决定是否显示下拉框
if (loginConfig.tenantMode === 'single') {
    if (loginConfig.showTenantSelect) {
        // 显示下拉框，但只有一个选项（默认租户）
        // 用户无感知，下拉框自动选中默认租户
        this.loginForm.tenantId = '1'; // String类型
        this.tenantList = [{ tenantId: '1', tenantName: '默认租户' }];
    } else {
        // 不显示下拉框，直接登录
        // 系统自动使用默认租户
        this.loginForm.tenantId = '1'; // 隐藏字段，String类型
    }
}
```

### 10.3 多租户模式实现

#### 10.3.1 自动判断
```java
// 系统启动时或登录配置获取时自动判断
public LoginConfigVO getLoginConfig() {
    LoginConfigVO config = new LoginConfigVO();
    
    // 查询租户数量
    int tenantCount = sysTenantService.count();
    
    // 自动判断模式
    if (tenantCount <= 1) {
        config.setTenantMode("single");
        config.setShowTenantSelect(getConfigValue("sys.login.showTenantSelect", "false"));
    } else {
        config.setTenantMode("multi");
        config.setShowTenantSelect(true); // 多租户模式强制显示
    }
    
    return config;
}
```

#### 10.3.2 用户选择
```javascript
// 多租户模式：必须显示租户选择
if (loginConfig.tenantMode === 'multi') {
    // 显示租户下拉框
    this.showTenantSelect = true;
    // 获取用户可访问的租户列表
    this.tenantList = await getTenantList(this.loginForm.userName);
    // 用户必须选择一个租户
    if (!this.loginForm.tenantId) {
        this.$message.error('请选择租户');
        return;
    }
}
```

### 10.4 平滑升级路径

#### 10.4.1 从单租户升级到多租户
1. **无需修改代码**：代码已支持多租户
2. **创建新租户**（tenant_id使用字符串）：
   ```sql
   INSERT INTO sys_tenant (tenant_id, tenant_name, tenant_code) 
   VALUES ('2', '新租户', 'TENANT_2');
   ```
3. **分配用户到新租户**（tenant_id使用字符串）：
   ```sql
   INSERT INTO sys_user_tenant (user_id, tenant_id)
   VALUES (user_id, '2');
   ```
4. **系统自动切换**：
   - 租户数量 > 1，系统自动识别为多租户模式
   - 登录界面自动显示租户选择下拉框
   - 用户可以选择不同租户登录

#### 10.4.2 从多租户降级到单租户
1. **删除多余租户**（保留租户'1'，注意tenant_id为字符串）：
   ```sql
   DELETE FROM sys_tenant WHERE tenant_id != '1';
   DELETE FROM sys_user_tenant WHERE tenant_id != '1';
   ```
2. **系统自动切换**：
   - 租户数量 = 1，系统自动识别为单租户模式
   - 登录界面根据配置决定是否显示下拉框

### 10.5 配置说明

| 配置项 | 单租户模式 | 多租户模式 | 说明 |
|--------|-----------|-----------|------|
| `sys.tenant.mode` | `single` 或 `auto` | `multi` 或 `auto` | 租户模式（auto：自动判断） |
| `sys.login.showTenantSelect` | `true`/`false` | 强制 `true` | 是否显示租户选择 |
| `sys.tenant.defaultTenantId` | `'1'` | `'1'` | 默认租户ID（字符串类型） |

**配置优先级**：
1. 如果 `sys.tenant.mode = 'auto'`：系统根据租户数量自动判断
2. 如果 `sys.tenant.mode = 'single'`：强制单租户模式
3. 如果 `sys.tenant.mode = 'multi'`：强制多租户模式（即使只有1个租户）

## 十一、总结

本升级方案基于现有架构，采用MyBatis-Plus多租户插件实现数据隔离，通过配置表灵活控制登录界面，确保与Jimu、Magic-API等组件的集成。**核心设计理念是多租户架构兼容单租户模式，使用同一套代码逻辑，通过配置和租户数量自动判断模式，实现平滑升级。**

**关键成功因素**:
1. **统一架构设计**：单租户和多租户使用同一套代码
2. **灵活的登录配置**：通过配置表控制租户选择显示
3. **自动模式判断**：根据租户数量自动识别单租户/多租户模式
4. **平滑升级路径**：从单租户升级到多租户无需修改代码
5. **充分的测试验证**：确保数据安全和系统稳定
6. **完善的回滚方案**：支持快速回滚

**预计工作量**:
- 数据库设计：2天
- 后端开发：5-7天
- 前端开发：3-5天
- 集成测试：3-5天
- 总计：13-19天

**核心优势**:
- ✅ 单租户和多租户使用同一套代码，降低维护成本
- ✅ 从单租户升级到多租户无需修改代码，只需创建新租户
- ✅ 用户无感知切换，单租户模式下自动使用默认租户
- ✅ 灵活的配置机制，支持单租户模式下显示/隐藏租户选择

