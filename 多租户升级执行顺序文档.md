# 多租户升级执行顺序文档

## 升级总览

**升级目标**：将单租户系统升级为支持单租户/多租户的统一架构

**预计总时长**：14-20个工作日

**升级原则**：
- ✅ 分阶段实施，每阶段验证通过后再进行下一阶段
- ✅ 保留回滚能力，每个阶段都可以回滚
- ✅ 充分测试，确保功能正常
- ✅ 单租户兼容，升级过程中不影响现有功能


### 步骤1.3：升级方案评审（1天）

**目标**：团队评审升级方案，确认实施细节

**执行内容**：
1. **技术方案评审**
   - 评审数据库设计
   - 评审代码改造方案
   - 确认技术选型

2. **风险评估**
   - 识别潜在风险点
   - 制定风险应对措施
   - 确认回滚方案

3. **资源分配**
   - 分配开发人员
   - 分配测试人员
   - 分配DBA支持

4. **时间计划**
   - 确认各阶段时间节点
   - 确认里程碑

**验收标准**：
- ✅ 升级方案已评审通过
- ✅ 风险应对措施已确认
- ✅ 资源已分配到位
- ✅ 时间计划已确认

---

## 第二阶段：数据库设计与迁移（2-3天）

### 步骤2.1：创建新表（0.5天）

**目标**：创建多租户相关的核心表

**执行顺序**：
1. **创建租户表（sys_tenant）**
   ```sql
   CREATE TABLE `sys_tenant` (
     `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
     `tenant_name` varchar(100) NOT NULL COMMENT '租户名称',
     `tenant_code` varchar(50) DEFAULT NULL COMMENT '租户编码',
     `contact_name` varchar(50) DEFAULT NULL COMMENT '联系人',
     `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系电话',
     `contact_email` varchar(100) DEFAULT NULL COMMENT '联系邮箱',
     `status` char(1) DEFAULT '0' COMMENT '状态（0正常 1停用）',
     `del_flag` char(1) DEFAULT '0' COMMENT '删除标志（0存在 2删除）',
     `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
     `create_time` datetime DEFAULT NULL COMMENT '创建时间',
     `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
     `update_time` datetime DEFAULT NULL COMMENT '更新时间',
     `remark` varchar(500) DEFAULT NULL COMMENT '备注',
     PRIMARY KEY (`tenant_id`),
     UNIQUE KEY `uk_tenant_code` (`tenant_code`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户表';
   ```

2. **创建用户租户关系表（sys_user_tenant）**
   ```sql
   CREATE TABLE `sys_user_tenant` (
     `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
     `user_id` bigint(20) NOT NULL COMMENT '用户ID',
     `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
     `disabled` char(1) DEFAULT '0' COMMENT '是否禁用（0正常 1禁用）',
     `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
     `create_time` datetime DEFAULT NULL COMMENT '创建时间',
     `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
     `update_time` datetime DEFAULT NULL COMMENT '更新时间',
     PRIMARY KEY (`id`),
     UNIQUE KEY `uk_user_tenant` (`user_id`, `tenant_id`),
     KEY `idx_tenant_id` (`tenant_id`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户租户关系表';
   ```

3. **创建租户菜单表（sys_menu_pack）**
   ```sql
   CREATE TABLE `sys_menu_pack` (
     `pack_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '租户菜单ID',
     `pack_name` varchar(100) NOT NULL COMMENT '租户菜单名称',
     `pack_code` varchar(50) DEFAULT NULL COMMENT '租户菜单编码',
     `status` char(1) DEFAULT '0' COMMENT '状态（0正常 1停用）',
     `remark` varchar(500) DEFAULT NULL COMMENT '备注',
     `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
     `create_time` datetime DEFAULT NULL COMMENT '创建时间',
     `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
     `update_time` datetime DEFAULT NULL COMMENT '更新时间',
     PRIMARY KEY (`pack_id`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单表';
   ```

4. **创建租户菜单详情表（sys_menu_pack_detail）**
   ```sql
   CREATE TABLE `sys_menu_pack_detail` (
     `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
     `pack_id` bigint(20) NOT NULL COMMENT '租户菜单ID',
     `menu_id` bigint(20) NOT NULL COMMENT '菜单ID',
     PRIMARY KEY (`id`),
     UNIQUE KEY `uk_pack_menu` (`pack_id`, `menu_id`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单详情表';
   ```

5. **创建租户菜单关联表（sys_tenant_menu_pack）**
   ```sql
   CREATE TABLE `sys_tenant_menu_pack` (
     `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
     `tenant_id` varchar(50) NOT NULL COMMENT '租户ID',
     `pack_id` bigint(20) NOT NULL COMMENT '租户菜单ID',
     `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
     `create_time` datetime DEFAULT NULL COMMENT '创建时间',
     PRIMARY KEY (`id`),
     UNIQUE KEY `uk_tenant_pack` (`tenant_id`, `pack_id`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户菜单关联表';
   ```

**验收标准**：
- ✅ 所有新表已创建成功
- ✅ 表结构符合设计文档
- ✅ 索引已创建
- ✅ 在测试环境验证通过

**回滚方案**：
```sql
DROP TABLE IF EXISTS `sys_tenant_menu_pack`;
DROP TABLE IF EXISTS `sys_menu_pack_detail`;
DROP TABLE IF EXISTS `sys_menu_pack`;
DROP TABLE IF EXISTS `sys_user_tenant`;
DROP TABLE IF EXISTS `sys_tenant`;
```

---

### 步骤2.2：修改现有表结构（1天）

**目标**：为现有表添加租户相关字段

**执行顺序**：
1. **修改用户表（sys_user）**
   ```sql
   -- 检查字段是否已存在
   SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = 'boot-java' AND TABLE_NAME = 'sys_user' AND COLUMN_NAME = 'is_sys';
   
   -- 如果不存在，则添加
   ALTER TABLE `sys_user` 
     ADD COLUMN `is_sys` char(1) DEFAULT '0' COMMENT '是否系统用户（0否 1是）' AFTER `user_type`,
     ADD COLUMN `admin_login_tenant_id` varchar(50) DEFAULT NULL COMMENT '管理后台最后登录租户ID' AFTER `login_date`,
     ADD COLUMN `business_login_tenant_id` varchar(50) DEFAULT NULL COMMENT '业务后台最后登录租户ID' AFTER `admin_login_tenant_id`;
   ```

2. **修改部门表（sys_dept）**
   ```sql
   -- 检查字段是否已存在
   SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = 'boot-java' AND TABLE_NAME = 'sys_dept' AND COLUMN_NAME = 'tenant_id';
   
   -- 如果不存在，则添加
   ALTER TABLE `sys_dept` 
     ADD COLUMN `tenant_id` varchar(50) DEFAULT NULL COMMENT '租户ID' AFTER `dept_id`;
   
   -- 创建索引
   CREATE INDEX `idx_tenant_id` ON `sys_dept` (`tenant_id`);
   ```

3. **修改角色表（sys_role）**
   ```sql
   -- 检查字段是否已存在
   SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = 'boot-java' AND TABLE_NAME = 'sys_role' AND COLUMN_NAME = 'tenant_id';
   
   -- 如果不存在，则添加
   ALTER TABLE `sys_role` 
     ADD COLUMN `tenant_id` varchar(50) DEFAULT NULL COMMENT '租户ID（0表示管理后台角色）' AFTER `role_id`,
     ADD COLUMN `is_admin` char(1) DEFAULT '0' COMMENT '是否管理员（0否 1是）' AFTER `role_key`;
   
   -- 创建索引
   CREATE INDEX `idx_tenant_id` ON `sys_role` (`tenant_id`);
   ```

4. **修改菜单表（sys_menu）**
   ```sql
   -- 检查字段是否已存在
   SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = 'boot-java' AND TABLE_NAME = 'sys_menu' AND COLUMN_NAME = 'is_sys';
   
   -- 如果不存在，则添加
   ALTER TABLE `sys_menu` 
     ADD COLUMN `is_sys` char(1) DEFAULT '0' COMMENT '是否系统菜单（0业务菜单 1系统菜单）' AFTER `menu_type`;
   ```

5. **检查其他业务表**
   - 检查所有业务表是否已有 `tenant_id` 字段
   - 如果没有，需要添加（根据实际业务表情况）

**验收标准**：
- ✅ 所有表结构修改完成
- ✅ 索引已创建
- ✅ 字段类型正确（varchar(50)）
- ✅ 在测试环境验证通过

**回滚方案**：
```sql
-- 删除添加的字段（谨慎操作）
ALTER TABLE `sys_user` DROP COLUMN `is_sys`, DROP COLUMN `admin_login_tenant_id`, DROP COLUMN `business_login_tenant_id`;
ALTER TABLE `sys_dept` DROP COLUMN `tenant_id`, DROP INDEX `idx_tenant_id`;
ALTER TABLE `sys_role` DROP COLUMN `tenant_id`, DROP COLUMN `is_admin`, DROP INDEX `idx_tenant_id`;
ALTER TABLE `sys_menu` DROP COLUMN `is_sys`;
```

---

### 步骤2.3：数据迁移（1天）

**目标**：迁移现有数据，设置默认租户（同时作为平台租户）

**执行顺序**：
1. **创建默认租户（平台租户）**
   ```sql
   INSERT INTO sys_tenant (tenant_id, tenant_name, tenant_code, status, create_by, create_time)
   VALUES ('0', '默认租户（平台租户）', 'DEFAULT', '0', 'admin', NOW());
   
   -- 验证
   SELECT * FROM sys_tenant WHERE tenant_id = '0';
   ```

2. **为现有用户创建租户关系**
   ```sql
   -- 先检查是否有数据
   SELECT COUNT(*) FROM sys_user WHERE del_flag = '0';
   
   -- 创建租户关系（单租户模式下，所有用户默认属于平台/默认租户 tenant_id = '0'）
   INSERT INTO sys_user_tenant (user_id, tenant_id, disabled, create_by, create_time)
   SELECT user_id, '0', '0', 'admin', NOW() 
   FROM sys_user 
   WHERE del_flag = '0' 
   AND NOT EXISTS (
     SELECT 1 FROM sys_user_tenant WHERE sys_user_tenant.user_id = sys_user.user_id
   );
   
   -- 验证
   SELECT COUNT(*) FROM sys_user_tenant WHERE tenant_id = '0';
   ```

3. **为现有部门设置租户ID**
   ```sql
   -- 更新部门租户ID
   UPDATE sys_dept 
   SET tenant_id = '0' 
   WHERE tenant_id IS NULL;
   
   -- 验证
   SELECT COUNT(*) FROM sys_dept WHERE tenant_id = '0';
   SELECT COUNT(*) FROM sys_dept WHERE tenant_id IS NULL; -- 应该为0
   ```

4. **为现有角色设置租户ID**
   ```sql
   -- 平台角色和业务角色均挂在默认租户（平台租户） tenant_id = '0' 下，通过 is_sys / is_admin 区分
   UPDATE sys_role 
   SET tenant_id = '0' 
   WHERE tenant_id IS NULL;
   
   -- 验证
   SELECT COUNT(*) FROM sys_role WHERE tenant_id = '0';
   SELECT COUNT(*) FROM sys_role WHERE tenant_id IS NULL; -- 应该为0
   ```

5. **设置菜单的 is_sys 标识**
   ```sql
   -- 根据实际菜单分类设置
   -- 管理后台菜单设置为 is_sys = '1'
   -- 业务菜单设置为 is_sys = '0'
   -- 需要根据实际菜单情况调整
   
   -- 示例：假设菜单ID小于100的是系统菜单
   UPDATE sys_menu SET is_sys = '1' WHERE menu_id < 100;
   UPDATE sys_menu SET is_sys = '0' WHERE menu_id >= 100 AND is_sys IS NULL;
   ```

6. **为其他业务表设置租户ID**
   ```sql
   -- 根据实际业务表情况，为所有业务数据设置 tenant_id = '0'
   -- 例如：
   -- UPDATE 业务表名 SET tenant_id = '1' WHERE tenant_id IS NULL;
   ```

**验收标准**：
- ✅ 默认租户已创建
- ✅ 所有用户都有租户关系
- ✅ 所有部门都有租户ID
- ✅ 所有角色都有租户ID
- ✅ 所有业务数据都有租户ID
- ✅ 数据完整性验证通过

**回滚方案**：
```sql
-- 删除租户关系
DELETE FROM sys_user_tenant;
DELETE FROM sys_tenant;

-- 清空租户ID（谨慎操作）
UPDATE sys_dept SET tenant_id = NULL;
UPDATE sys_role SET tenant_id = NULL;
-- 其他业务表类似处理
```

---

### 步骤2.4：添加登录配置（0.5天）

**目标**：在配置表中添加登录相关配置

**执行内容**：
```sql
-- 登录界面配置：是否显示租户选择
INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
VALUES ('登录界面-是否显示租户选择', 'sys.login.showTenantSelect', 'false', 'Y', 'admin', NOW(), '是否在登录界面显示租户选择下拉框（true显示 false隐藏，单租户模式有效，多租户模式强制显示）');

-- 系统模式配置：单租户/多租户
INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
VALUES ('系统模式-租户模式', 'sys.tenant.mode', 'auto', 'Y', 'admin', NOW(), '系统租户模式：auto自动判断 single单租户 multi多租户（auto：根据租户数量自动判断）');

   -- 默认租户ID配置
   INSERT INTO `sys_config` (`config_name`, `config_key`, `config_value`, `config_type`, `create_by`, `create_time`, `remark`) 
   VALUES ('系统配置-默认租户ID', 'sys.tenant.defaultTenantId', '0', 'Y', 'admin', NOW(), '单租户模式下的默认租户ID，通常为\"0\"（字符串类型，平台/默认租户）');

-- 验证
SELECT * FROM sys_config WHERE config_key LIKE 'sys.%';
```

**验收标准**：
- ✅ 配置项已添加
- ✅ 配置值正确
- ✅ 可以正常查询配置

**回滚方案**：
```sql
DELETE FROM sys_config WHERE config_key IN ('sys.login.showTenantSelect', 'sys.tenant.mode', 'sys.tenant.defaultTenantId');
```

---

## 第三阶段：后端核心功能开发（3-4天）

### 步骤3.1：更新配置文件（0.5天）

**目标**：启用多租户配置

**执行内容**：
1. **修改 application.yml**
   ```yaml
   tenant:
     # 租户模式是否启用
     enable: true
     # 租户字段名（统一使用 tenant_id，与Jimu、工作流保持一致）
     column: tenant_id
     # 默认租户ID（单租户模式使用'0'，即平台/默认租户，字符串类型）
     defaultTenantId: '0'
     # 排除表（不进行租户过滤的表）
     excludes:
       - sys_tenant
       - sys_menu_pack
       - sys_menu_pack_detail
       - sys_tenant_menu_pack
       - sys_user_tenant
       - sys_config
       - sys_dict_data
       - sys_dict_type
       - sys_menu
       - sys_user
       - sys_role_menu
       - sys_user_role
       - sys_user_post
       - sys_role_dept
       # ... 其他排除表
   ```

2. **验证配置**
   - 启动应用，检查是否报错
   - 检查租户拦截器是否生效

**验收标准**：
- ✅ 配置文件已更新
- ✅ 应用可以正常启动
- ✅ 租户拦截器已启用

**回滚方案**：
```yaml
tenant:
  enable: false  # 关闭多租户
```

---

### 步骤3.2：调整租户拦截器（0.5天）

**目标**：修改租户拦截器，支持字符串类型的tenant_id

**执行内容**：
1. **修改 TenantMybatisPlusConfig.java**
   ```java
   @Override
   public Expression getTenantId() {
       //从登录信息中获取当前租户ID（String类型）
       String tenantId = SecurityUtils.getCurrentTenantId();
       if (tenantId == null) {
           return new NullValue();
       }
       // 使用StringValue而不是LongValue，因为tenant_id是varchar类型
       return new StringValue(tenantId);
   }
   ```

2. **添加导入**
   ```java
   import net.sf.jsqlparser.expression.StringValue;
   ```

3. **验证**
   - 启动应用
   - 执行一个查询，检查SQL是否自动添加了tenant_id条件

**验收标准**：
- ✅ 代码已修改
- ✅ 编译通过
- ✅ SQL自动添加tenant_id条件

**回滚方案**：
- 恢复原来的代码（使用LongValue）

---

### 步骤3.3：创建租户实体类和Mapper（0.5天）

**目标**：创建租户相关的实体类、Mapper、Service

**执行内容**：
1. **创建实体类**
   - `SysTenant.java` - 租户实体
   - `SysUserTenant.java` - 用户租户关系实体
   - `SysMenuPack.java` - 租户菜单实体
   - `SysMenuPackDetail.java` - 租户菜单详情实体
   - `SysTenantMenuPack.java` - 租户菜单关联实体

2. **创建Mapper接口**
   - `SysTenantMapper.java`
   - `SysUserTenantMapper.java`
   - `SysMenuPackMapper.java`
   - 等等

3. **创建Mapper XML文件**
   - 对应的XML映射文件

4. **创建Service接口和实现**
   - `ISysTenantService.java` 和 `SysTenantServiceImpl.java`
   - `ISysUserTenantService.java` 和 `SysUserTenantServiceImpl.java`
   - 等等

**验收标准**：
- ✅ 所有实体类已创建
- ✅ Mapper接口已创建
- ✅ Service接口和实现已创建
- ✅ 编译通过

---

### 步骤3.4：改造登录服务（1.5天）

**目标**：修改登录逻辑，支持租户选择

**执行内容**：
1. **修改 UserSaServiceImpl.java**
   - 添加租户查询逻辑
   - 处理单租户/多租户判断
   - 处理管理后台/业务后台登录

2. **修改 LoginBody.java**
   - 添加 `tenantId` 字段（String类型）
   - 添加 `isAdminLogin` 字段

3. **修改 LoginUser.java**
   - 添加 `tenantId` 字段
   - 添加 `tenantName` 字段

4. **修改 SecurityUtils**
   - 添加 `getCurrentTenantId()` 方法（返回String）
   - 添加 `setCurrentTenantId()` 方法

**关键代码逻辑**：
```java
// 判断是否为管理后台登录
Boolean isAdminLogin = AuthenticationContextHolder.getIsAdminLogin();
String currentTenantId = Constants.ADMIN_DEFAULT_TENANT_ID; // "0"

if (!isAdminLogin) {
    // 业务后台登录：查询用户所属租户
    List<SysUserTenant> userTenantList = sysUserTenantService.selectByUserId(userId);
    if (userTenantList == null || userTenantList.isEmpty()) {
        // 单租户模式：如果没有租户关系，使用默认租户
        currentTenantId = Constants.DEFAULT_TENANT_ID; // "1"
    } else if (userTenantList.size() == 1) {
        // 单租户模式：只有一个租户，直接使用
        currentTenantId = userTenantList.get(0).getTenantId();
    } else {
        // 多租户模式：多个租户，优先使用上次登录的租户
        String lastTenantId = user.getBusinessLoginTenantId();
        if (lastTenantId != null && userTenantList.stream().anyMatch(ut -> ut.getTenantId().equals(lastTenantId))) {
            currentTenantId = lastTenantId;
        } else {
            currentTenantId = userTenantList.get(0).getTenantId();
        }
    }
}
```

**验收标准**：
- ✅ 登录逻辑已改造
- ✅ 单租户模式可以正常登录
- ✅ 多租户模式可以正常登录
- ✅ 管理后台登录正常

**测试要点**：
- 单租户模式登录测试
- 多租户模式登录测试
- 管理后台登录测试
- 租户切换测试

---

### 步骤3.5：改造登录接口（1天）

**目标**：修改登录接口，支持租户参数

**执行内容**：
1. **修改 SysLoginController.java**
   - 修改 `/login` 接口，支持 `tenantId` 参数
   - 新增 `/getTenantList` 接口

2. **新增登录配置接口**
   - 新增 `/getLoginConfig` 接口
   - 返回登录配置信息

3. **创建VO类**
   - `LoginConfigVO.java` - 登录配置VO
   - `TenantVO.java` - 租户VO

**验收标准**：
- ✅ 登录接口已改造
- ✅ 新增接口已实现
- ✅ 接口测试通过

---

## 第四阶段：后端管理功能开发（2-3天）

### 步骤4.1：租户管理功能（1.5天）

**目标**：实现租户的CRUD功能

**执行内容**：
1. **创建 SysTenantController.java**
   - 租户列表查询
   - 租户新增
   - 租户修改
   - 租户删除
   - 租户详情查询

2. **完善 Service 层**
   - 实现业务逻辑
   - 参数校验
   - 异常处理

3. **前端页面**（可选，如果后端先开发）
   - 租户列表页面
   - 租户新增/编辑页面

**验收标准**：
- ✅ 租户CRUD功能完整
- ✅ 参数校验正确
- ✅ 异常处理完善
- ✅ 接口测试通过

---

### 步骤4.2：用户租户关系管理（0.5天）

**目标**：实现用户与租户的关联管理

**执行内容**：
1. **在用户管理中添加租户分配功能**
   - 用户列表显示所属租户
   - 用户分配租户
   - 用户移除租户关系

2. **在租户管理中添加用户分配功能**
   - 租户详情显示用户列表
   - 为租户分配用户
   - 从租户移除用户

**验收标准**：
- ✅ 用户租户关系管理功能完整
- ✅ 可以正常分配和移除
- ✅ 数据一致性验证通过

---

### 步骤4.3：租户菜单管理功能（1.5天）

**目标**：实现租户菜单的分配和管理

**执行内容**：
1. **租户菜单管理**
   - 创建租户菜单
   - 编辑租户菜单
   - 删除租户菜单
   - 租户菜单详情

2. **菜单分配功能**
   - 为租户菜单分配菜单
   - 为租户分配租户菜单
   - 菜单权限缓存更新

3. **菜单权限处理**
   - 租户菜单变更时更新缓存
   - 确保菜单权限正确

**验收标准**：
- ✅ 租户菜单管理功能完整
- ✅ 菜单分配功能正常
- ✅ 菜单权限缓存更新正确
- ✅ 用户菜单权限验证通过

---

## 第五阶段：前端功能开发（3-5天）

### 步骤5.1：登录页面改造（1.5天）

**目标**：改造登录页面，支持租户选择

**执行内容**：
1. **修改 login.vue**
   - 添加租户选择下拉框
   - 根据配置动态显示/隐藏
   - 处理单租户/多租户逻辑

2. **添加登录配置获取**
   - 页面加载时获取登录配置
   - 根据配置决定是否显示租户选择

3. **添加租户列表获取**
   - 登录前获取用户可访问的租户列表
   - 处理多租户选择逻辑

**关键代码逻辑**：
```javascript
// 获取登录配置
async getLoginConfig() {
  const res = await getLoginConfig();
  this.loginConfig = res.data;
  
  // 自动判断租户模式
  if (this.loginConfig.tenantMode === 'auto') {
    this.loginConfig.tenantMode = this.loginConfig.tenantCount > 1 ? 'multi' : 'single';
  }
  
  // 根据配置决定是否显示租户选择
  if (this.loginConfig.tenantMode === 'multi') {
    this.loginConfig.showTenantSelect = true;
    if (this.loginForm.userName) {
      await this.getTenantList(this.loginForm.userName);
    }
  } else {
    if (this.loginConfig.showTenantSelect) {
      this.loginForm.tenantId = this.loginConfig.defaultTenantId;
      this.loginConfig.tenantList = [{
        tenantId: this.loginConfig.defaultTenantId,
        tenantName: '默认租户'
      }];
    } else {
      this.loginForm.tenantId = this.loginConfig.defaultTenantId;
    }
  }
}
```

**验收标准**：
- ✅ 登录页面已改造
- ✅ 单租户模式可以正常显示/隐藏租户选择
- ✅ 多租户模式必须显示租户选择
- ✅ 登录功能正常

**测试要点**：
- 单租户模式（不显示下拉框）登录测试
- 单租户模式（显示下拉框）登录测试
- 多租户模式登录测试
- 管理后台登录测试

---

### 步骤5.2：用户Store改造（0.5天）

**目标**：在用户Store中存储租户信息

**执行内容**：
1. **修改 user.js**
   - 添加租户相关state
   - 添加租户相关mutations
   - 添加租户相关actions

2. **修改登录逻辑**
   - 登录成功后保存租户信息
   - 退出登录时清除租户信息

**验收标准**：
- ✅ Store已改造
- ✅ 租户信息可以正常存储和获取
- ✅ 退出登录时清除正确

---

### 步骤5.3：租户管理页面（1.5天）

**目标**：实现租户管理的完整页面

**执行内容**：
1. **租户列表页面**
   - 租户列表展示
   - 租户搜索
   - 租户新增/编辑/删除

2. **租户详情页面**
   - 租户基本信息
   - 租户用户列表
   - 租户菜单分配

**验收标准**：
- ✅ 租户管理页面完整
- ✅ 功能正常
- ✅ 用户体验良好

---

### 步骤5.4：租户菜单管理页面（1天）

**目标**：实现租户菜单管理的完整页面

**执行内容**：
1. **租户菜单列表页面**
   - 租户菜单列表展示
   - 租户菜单新增/编辑/删除

2. **菜单分配页面**
   - 为租户菜单分配菜单
   - 为租户分配租户菜单

**验收标准**：
- ✅ 租户菜单管理页面完整
- ✅ 菜单分配功能正常
- ✅ 用户体验良好

---

### 步骤5.5：租户切换功能（0.5天）

**目标**：在业务后台实现租户切换功能

**执行内容**：
1. **添加租户切换组件**
   - 在顶部导航栏添加租户切换下拉框
   - 显示当前租户
   - 支持切换租户

2. **实现租户切换逻辑**
   - 切换租户时重新加载用户信息
   - 更新菜单权限
   - 更新缓存

**验收标准**：
- ✅ 租户切换功能正常
- ✅ 切换后菜单权限正确
- ✅ 切换后数据隔离正确

---

## 第六阶段：集成组件适配（1-2天）

### 步骤6.1：Jimu报表适配（0.5天）

**目标**：确保Jimu报表支持多租户

**执行内容**：
1. **验证Jimu表结构**
   - 确认Jimu表已有 `tenant_id` 字段
   - 确认字段类型为 `varchar`

2. **验证租户隔离**
   - 测试报表查询是否自动过滤租户
   - 测试报表创建时是否自动设置租户ID

3. **如有问题，进行调整**
   - 修改相关代码
   - 确保租户隔离正确

**验收标准**：
- ✅ Jimu报表支持多租户
- ✅ 报表数据按租户隔离
- ✅ 报表创建时自动设置租户ID

---

### 步骤6.2：Magic-API适配（1天）

**目标**：确保Magic-API支持多租户上下文

**执行内容**：
1. **创建Magic-API租户配置**
   - 创建 `MagicApiTenantConfig.java`
   - 注册租户全局变量

2. **验证租户上下文**
   - 测试API脚本中是否可以获取租户ID
   - 测试API数据查询是否自动过滤租户

3. **如有问题，进行调整**

**验收标准**：
- ✅ Magic-API支持多租户
- ✅ API脚本可以获取租户上下文
- ✅ API数据查询自动过滤租户

---

### 步骤6.3：工作流引擎适配（0.5天）

**目标**：确保工作流引擎支持多租户

**执行内容**：
1. **验证工作流表结构**
   - 确认工作流表已有 `tenant_id` 字段
   - 确认字段类型为 `varchar`

2. **验证租户隔离**
   - 测试流程查询是否自动过滤租户
   - 测试流程创建时是否自动设置租户ID

3. **如有问题，进行调整**

**验收标准**：
- ✅ 工作流引擎支持多租户
- ✅ 流程数据按租户隔离
- ✅ 流程创建时自动设置租户ID

---
 
